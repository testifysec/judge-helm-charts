suite: Multi-Service Marketplace Image Configuration
templates:
  - templates/gateway/deployment.yaml

tests:
  # Test 1: Marketplace ECR configuration with all services
  - it: should configure marketplace ECR for complete deployment
    set:
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0
      judge-api.image.tag: v1.15.0
      archivista.image.tag: v1.15.0
      judge-web.image.tag: v1.15.0
    asserts:
      # Gateway uses marketplace ECR
      - equal:
          path: spec.template.spec.containers[0].image
          value: "709825985650.dkr.ecr.us-east-1.amazonaws.com/testifysec/judge-gateway:v1.15.0"

  # Test 2: Custom registry for all services
  - it: should configure custom registry for all services
    set:
      global.registry.awsMarketplace: false
      global.registry.url: ghcr.io
      global.registry.repository: myorg
      gateway.image.tag: v1.15.0
      judge-api.image.tag: v1.15.0
      archivista.image.tag: v1.15.0
      judge-web.image.tag: v1.15.0
    asserts:
      # Gateway uses custom registry
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/myorg/judge-gateway:v1.15.0"

  # Test 3: GCP Artifact Registry for all services
  - it: should configure GCP Artifact Registry for all services
    set:
      global.registry.awsMarketplace: false
      global.registry.url: us-east4-docker.pkg.dev
      global.registry.repository: judge-395516/judge-image-registry
      gateway.image.tag: v1.15.0
      judge-api.image.tag: v1.15.0
      archivista.image.tag: v1.15.0
      judge-web.image.tag: v1.15.0
    asserts:
      # Gateway uses GCP Artifact Registry
      - equal:
          path: spec.template.spec.containers[0].image
          value: "us-east4-docker.pkg.dev/judge-395516/judge-image-registry/judge-gateway:v1.15.0"

  # Test 4: Multi-region marketplace (always us-east-1)
  - it: should always use us-east-1 for marketplace regardless of region
    set:
      global.aws.region: eu-west-1
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0
    asserts:
      # Marketplace always uses us-east-1
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ".*us-east-1.*"
      - notMatchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ".*eu-west-1.*"

  # Test 5: Version tag precision across services
  - it: should preserve version tag precision
    set:
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0-rc1
      judge-api.image.tag: v2.0.0-hotfix
      archivista.image.tag: v1.14.0-beta.1
      judge-web.image.tag: main-abc123
    asserts:
      # Gateway preserves its specific tag
      - equal:
          path: spec.template.spec.containers[0].image
          value: "709825985650.dkr.ecr.us-east-1.amazonaws.com/testifysec/judge-gateway:v1.15.0-rc1"

  # Test 6: Dev mode with marketplace
  - it: should support dev mode with marketplace for all services
    set:
      global.dev: true
      localstack.enabled: true
      postgresql.enabled: true
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0
      judge-api.image.tag: v1.15.0
      archivista.image.tag: v1.15.0
      judge-web.image.tag: v1.15.0
    asserts:
      # Dev mode with marketplace ECR
      - equal:
          path: spec.template.spec.containers[0].image
          value: "709825985650.dkr.ecr.us-east-1.amazonaws.com/testifysec/judge-gateway:v1.15.0"

  # Test 7: Cross-account ECR (non-marketplace)
  - it: should support cross-account ECR registry
    set:
      global.registry.awsMarketplace: false
      global.registry.url: 178674732984.dkr.ecr.us-east-1.amazonaws.com
      global.registry.repository: judge-internal
      gateway.image.tag: v1.15.0
      judge-api.image.tag: v1.15.0
      archivista.image.tag: v1.15.0
      judge-web.image.tag: v1.15.0
    asserts:
      # Cross-account ECR configuration
      - equal:
          path: spec.template.spec.containers[0].image
          value: "178674732984.dkr.ecr.us-east-1.amazonaws.com/judge-internal/judge-gateway:v1.15.0"

  # Test 8: Docker Hub format
  - it: should support Docker Hub format
    set:
      global.registry.awsMarketplace: false
      global.registry.url: docker.io
      global.registry.repository: testifysec
      gateway.image.tag: latest
      judge-api.image.tag: latest
      archivista.image.tag: latest
      judge-web.image.tag: latest
    asserts:
      # Docker Hub format
      - equal:
          path: spec.template.spec.containers[0].image
          value: "docker.io/testifysec/judge-gateway:latest"

  # Test 9: Registry switching without affecting image names
  - it: should preserve image names when switching registries
    set:
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0
    asserts:
      # Image name remains consistent across registry switches
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "/judge-gateway:"

  # Test 10: Marketplace seller namespace consistency
  - it: should include marketplace seller namespace in image paths
    set:
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0
    asserts:
      # All services should include seller namespace
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ".*/testifysec/.*"
