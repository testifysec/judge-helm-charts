suite: ServiceAccount Helm Golf - Global Configuration
templates:
  - charts/archivista/templates/serviceaccount.yaml
  - charts/judge-api/templates/serviceaccount.yaml
  - charts/kratos/templates/rbac.yaml
tests:
  - it: should use global ServiceAccount names when configured
    set:
      global.secrets.vault.serviceAccounts.archivista: "judge-platform-judge-archivista"
      global.secrets.vault.serviceAccounts.judgeApi: "judge-platform-judge-api"
      global.secrets.vault.serviceAccounts.kratos: "judge-platform-judge-kratos"
      archivista.serviceAccount.create: true
      judge-api.serviceAccount.create: true
      kratos.deployment.serviceAccount.create: true
    release:
      name: judge-platform-staging-marketplace
      namespace: staging-marketplace
    asserts:
      # Archivista should use global config, NOT release-prefixed default
      - template: charts/archivista/templates/serviceaccount.yaml
        equal:
          path: metadata.name
          value: "judge-platform-judge-archivista"

      # Judge API should use global config, NOT release-prefixed default
      - template: charts/judge-api/templates/serviceaccount.yaml
        equal:
          path: metadata.name
          value: "judge-platform-judge-api"

      # Kratos should use global config, NOT release-prefixed default
      - template: charts/kratos/templates/rbac.yaml
        documentIndex: 0
        equal:
          path: metadata.name
          value: "judge-platform-judge-kratos"

  - it: should prioritize local serviceAccount.name over global config
    set:
      global.secrets.vault.serviceAccounts.archivista: "global-name"
      archivista.serviceAccount.create: true
      archivista.serviceAccount.name: "local-override"
    release:
      name: test-release
    asserts:
      - template: charts/archivista/templates/serviceaccount.yaml
        equal:
          path: metadata.name
          value: "local-override"

  - it: should fall back to default when neither local nor global are set
    set:
      archivista.serviceAccount.create: true
    release:
      name: test-release
      namespace: test-ns
    asserts:
      - template: charts/archivista/templates/serviceaccount.yaml
        equal:
          path: metadata.name
          value: "test-release-judge-archivista"
