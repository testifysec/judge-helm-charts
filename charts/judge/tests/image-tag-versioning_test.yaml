suite: Image Tag Version Pinning
templates:
  - templates/gateway/deployment.yaml

tests:
  # Test 1: Semantic versioning precision
  - it: should preserve semantic versioning (major.minor.patch)
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testifysec/judge-gateway:v1.15.0"

  # Test 2: Pre-release version with rc (release candidate)
  - it: should preserve rc pre-release versions
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0-rc1
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testifysec/judge-gateway:v1.15.0-rc1"

  # Test 3: Beta pre-release version
  - it: should preserve beta pre-release versions
    set:
      global.registry.url: docker.io
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0-beta.2
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "docker.io/testifysec/judge-gateway:v1.15.0-beta.2"

  # Test 4: Alpha pre-release version
  - it: should preserve alpha pre-release versions
    set:
      global.registry.url: quay.io
      global.registry.repository: testorg
      gateway.image.tag: v1.15.0-alpha.1
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "quay.io/testorg/judge-gateway:v1.15.0-alpha.1"

  # Test 5: Hotfix version
  - it: should preserve hotfix versions
    set:
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0-hotfix1
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "709825985650.dkr.ecr.us-east-1.amazonaws.com/testifysec/judge-gateway:v1.15.0-hotfix1"

  # Test 6: Commit SHA version (development)
  - it: should preserve commit SHA versions
    set:
      global.registry.url: registry.example.com
      global.registry.repository: dev
      gateway.image.tag: main-abc1234def5678
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "registry.example.com/dev/judge-gateway:main-abc1234def5678"

  # Test 7: Latest tag
  - it: should handle latest tag
    set:
      global.registry.url: docker.io
      global.registry.repository: testifysec
      gateway.image.tag: latest
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "docker.io/testifysec/judge-gateway:latest"

  # Test 8: Branch name tag (staging)
  - it: should preserve branch name tags
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testorg
      gateway.image.tag: staging-latest
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testorg/judge-gateway:staging-latest"

  # Test 9: Complex version with build metadata
  - it: should preserve complex version strings
    set:
      global.registry.url: registry.io
      global.registry.repository: platform
      gateway.image.tag: v2.0.0-rc.1.20240101T120000Z
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "registry.io/platform/judge-gateway:v2.0.0-rc.1.20240101T120000Z"

  # Test 10: Multiple digit versions
  - it: should handle multiple digit versions
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testifysec
      gateway.image.tag: v12.345.6789
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testifysec/judge-gateway:v12.345.6789"

  # Test 11: Version without v prefix
  - it: should handle versions without v prefix
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testifysec
      gateway.image.tag: 1.15.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testifysec/judge-gateway:1.15.0"

  # Test 12: Marketplace with version tag
  - it: should preserve marketplace with complex versions
    set:
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v2.0.0-beta.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "709825985650.dkr.ecr.us-east-1.amazonaws.com/testifysec/judge-gateway:v2.0.0-beta.3"
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":v2\\.0\\.0-beta\\.3$"

  # Test 13: Tag immutability (same config produces same image)
  - it: should produce identical image for identical config
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testorg
      gateway.image.tag: v1.15.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testorg/judge-gateway:v1.15.0"

  # Test 14: Extended version format (SemVer 2.0.0)
  - it: should handle extended semantic versioning
    set:
      global.registry.url: quay.io
      global.registry.repository: org
      gateway.image.tag: v1.0.0-x.7.z.92
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "quay.io/org/judge-gateway:v1.0.0-x.7.z.92"

  # Test 15: Timestamp-based version
  - it: should preserve timestamp-based versions
    set:
      global.registry.url: registry.io
      global.registry.repository: builds
      gateway.image.tag: "2024-01-15-1200"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "registry.io/builds/judge-gateway:2024-01-15-1200"

  # Test 16: Version with hyphens and numbers
  - it: should preserve hyphenated numeric versions
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testorg
      gateway.image.tag: release-3-4-2024
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testorg/judge-gateway:release-3-4-2024"

  # Test 17: Development tag variants
  - it: should preserve development tag variants
    set:
      global.registry.url: internal.registry.io
      global.registry.repository: dev
      gateway.image.tag: dev-feature-xyz
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "internal.registry.io/dev/judge-gateway:dev-feature-xyz"

  # Test 18: Patch version increment
  - it: should preserve patch version increments
    set:
      global.registry.awsMarketplace: true
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.1
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "709825985650.dkr.ecr.us-east-1.amazonaws.com/testifysec/judge-gateway:v1.15.1"
      - notMatchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "v1\\.15\\.0$"

  # Test 19: Major version zero
  - it: should preserve v0.x versions
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testorg
      gateway.image.tag: v0.15.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/testorg/judge-gateway:v0.15.0"

  # Test 20: Version tag regex validation
  - it: should match valid version tag patterns
    set:
      global.registry.url: ghcr.io
      global.registry.repository: testifysec
      gateway.image.tag: v1.15.0-rc1
    asserts:
      # Should match semantic version pattern
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ":v[0-9]+\\.[0-9]+\\.[0-9]+"
