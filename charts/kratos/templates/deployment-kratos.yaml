{{- include "kratos.automigration.typeVerification" . -}}
{{- $migrationExtraEnv := ternary .Values.deployment.automigration.extraEnv .Values.deployment.extraEnv (not (empty .Values.deployment.automigration.extraEnv )) -}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "kratos.fullname" . }}
  {{- if .Release.Namespace }}
  namespace: {{ .Release.Namespace }}
  {{- end }}
  labels:
    {{- include "kratos.labels" . | nindent 4 }}
    {{- with .Values.deployment.labels }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    {{- with .Values.deployment.annotations }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  progressDeadlineSeconds: 3600
{{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
{{- end }}
  revisionHistoryLimit: {{ .Values.deployment.revisionHistoryLimit }}
  strategy:
    {{- toYaml .Values.strategy | nindent 4 }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "kratos.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        {{- include "kratos.labels" . | nindent 8 }}
        {{- with .Values.deployment.labels }}
          {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with .Values.deployment.podMetadata.labels }}
          {{- toYaml . | nindent 8 }}
        {{- end }}
      annotations:
        {{- include "kratos.annotations.checksum" . | indent 8 -}}
        {{- with .Values.deployment.annotations }}
          {{- tpl (toYaml .) $ | nindent 8 }}
        {{- end }}
        {{- with .Values.deployment.podMetadata.annotations }}
          {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: {{ .Chart.Name }}-process-config
          image: public.ecr.aws/docker/library/busybox:latest
          imagePullPolicy: {{ include "judge.image.pullPolicy" . }}
          command:
            - /bin/sh
            - -c
            - |
              set -e  # Exit on any error

              echo "========================================="
              echo "Kratos Configuration Processor v2.0"
              echo "========================================="
              echo ""

              # Track errors
              ERRORS=0

              # Function to check environment variable
              check_env_var() {
                VAR_NAME=$1
                VAR_VALUE=$(eval echo \$$VAR_NAME)

                if [ -z "${VAR_VALUE}" ]; then
                  echo "ERROR: ${VAR_NAME} is not set or empty"
                  return 1
                else
                  # Show partial value for security (first 4 chars only)
                  MASKED_VALUE=$(echo "${VAR_VALUE}" | cut -c1-4)
                  echo "OK: ${VAR_NAME} is set (starts with: ${MASKED_VALUE}***)"
                  return 0
                fi
              }

              # Check if OIDC is enabled in config by looking for OIDC placeholder
              OIDC_ENABLED=false
              if grep -q '\${OIDC_GITHUB_CLIENT_ID}' /etc/config/kratos/kratos.yaml; then
                OIDC_ENABLED=true
              fi

              # Check OIDC environment variables only if OIDC is enabled
              if [ "$OIDC_ENABLED" = "true" ]; then
                echo "=== OIDC is enabled - Checking Credentials ==="

                if ! check_env_var "OIDC_GITHUB_CLIENT_ID"; then
                  ERRORS=$((ERRORS + 1))
                fi

                if ! check_env_var "OIDC_GITHUB_CLIENT_SECRET"; then
                  ERRORS=$((ERRORS + 1))
                fi
              else
                echo "=== OIDC is disabled - Skipping credential checks ==="
              fi

              if [ $ERRORS -gt 0 ]; then
                echo ""
                echo "========================================="
                echo "FATAL: Missing OIDC Credentials"
                echo "========================================="
                echo ""
                echo "OIDC authentication is enabled in Kratos config,"
                echo "but the GitHub OIDC credentials are not available."
                echo ""
                echo "TROUBLESHOOTING STEPS:"
                echo ""
                echo "1. Check if the Kratos secret exists:"
                echo "   kubectl get secret -n {{ .Release.Namespace }} | grep kratos"
                echo ""
                echo "2. The secret should be named: {{ include "kratos.secretname" . }}"
                echo ""
                echo "3. Verify the secret has ALL required keys:"
                echo "   kubectl describe secret {{ include "kratos.secretname" . }} -n {{ .Release.Namespace }}"
                echo ""
                echo "   Required keys for Kratos:"
                echo "   - dsn                     (Database connection string)"
                echo "   - secretsCookie           (Cookie encryption key)"
                echo "   - secretsCipher           (Field encryption key)"
                echo "   - oidcGithubClientId      (GitHub OAuth Client ID) ← MISSING"
                echo "   - oidcGithubClientSecret  (GitHub OAuth Secret) ← MISSING"
                echo ""
                echo "4. If using External Secrets Operator:"
                echo "   kubectl get externalsecret -n {{ .Release.Namespace }}"
                echo "   kubectl describe externalsecret {{ include "kratos.fullname" . }} -n {{ .Release.Namespace }}"
                echo ""
                echo "5. Example: Create the complete secret manually:"
                echo "   kubectl create secret generic {{ include "kratos.secretname" . }} \\"
                echo "     -n {{ .Release.Namespace }} \\"
                echo "     --from-literal=dsn='postgres://user:pass@host:5432/kratos' \\"
                echo "     --from-literal=secretsCookie=\$(openssl rand -base64 32) \\"
                echo "     --from-literal=secretsCipher=\$(openssl rand -base64 32) \\"
                echo "     --from-literal=oidcGithubClientId='YOUR_GITHUB_CLIENT_ID' \\"
                echo "     --from-literal=oidcGithubClientSecret='YOUR_GITHUB_SECRET'"
                echo ""
                echo "6. To disable OIDC (if not needed), set in values.yaml:"
                echo "   kratos:"
                echo "     kratos:"
                echo "       config:"
                echo "         selfservice:"
                echo "           methods:"
                echo "             oidc:"
                echo "               enabled: false"
                echo ""
                echo "========================================="
                exit 1
              fi

              echo ""
              echo "=== Processing Configuration Files ==="

              # Check source files exist
              if [ ! -f "/etc/config/kratos/kratos.yaml" ]; then
                echo "ERROR: Source kratos.yaml not found!"
                exit 1
              fi
              echo "OK: Found source kratos.yaml"

              # Process kratos.yaml with sed
              echo "Processing kratos.yaml with credential substitution..."
              sed -e "s/\${OIDC_GITHUB_CLIENT_ID}/${OIDC_GITHUB_CLIENT_ID}/g" \
                  -e "s/\${OIDC_GITHUB_CLIENT_SECRET}/${OIDC_GITHUB_CLIENT_SECRET}/g" \
                  /etc/config/kratos/kratos.yaml > /etc/config/kratos-processed/kratos.yaml

              # Validate substitution worked
              echo "Validating substitution..."
              if grep -q '\${OIDC_GITHUB' /etc/config/kratos-processed/kratos.yaml; then
                echo "ERROR: Some placeholders were not replaced:"
                grep -n '\${OIDC_GITHUB' /etc/config/kratos-processed/kratos.yaml
                exit 1
              fi
              echo "OK: All placeholders replaced successfully"

              # Validate YAML structure (check for empty values)
              echo "Checking for empty client_id or client_secret..."
              if grep -E "client_id:\s*$|client_secret:\s*$" /etc/config/kratos-processed/kratos.yaml > /dev/null; then
                echo "ERROR: Empty client_id or client_secret detected!"
                echo "This will cause Kratos validation to fail with nil values."
                grep -n -E "client_id:|client_secret:" /etc/config/kratos-processed/kratos.yaml | head -5
                exit 1
              else
                echo "OK: OIDC credentials appear to be set correctly"
              fi

              # Copy mapper files
              echo ""
              echo "=== Copying Mapper Files ==="
              for file in github.jsonnet gitlab.jsonnet; do
                if [ -f "/etc/config/kratos/${file}" ]; then
                  cp "/etc/config/kratos/${file}" /etc/config/kratos-processed/
                  echo "OK: Copied ${file}"
                else
                  echo "INFO: ${file} not found (may be optional)"
                fi
              done

              # Final summary
              echo ""
              echo "=== Final Configuration Status ==="
              ls -la /etc/config/kratos-processed/

              echo ""
              echo "========================================="
              echo "Configuration Processing Complete"
              echo "========================================="
              echo ""
              echo "Processed files:"
              for file in /etc/config/kratos-processed/*; do
                if [ -f "$file" ]; then
                  echo "  - $(basename $file) ($(wc -l < $file | tr -d ' ') lines)"
                fi
              done
              echo ""
              echo "OK: Kratos configuration is ready"
              echo ""
          volumeMounts:
            - name: {{ include "kratos.name" . }}-config-volume
              mountPath: /etc/config/kratos
              readOnly: true
            - name: {{ include "kratos.name" . }}-config-processed
              mountPath: /etc/config/kratos-processed
          env:
            {{- if .Values.oidc.github.existingSecret }}
            {{- if .Values.oidc.github.clientIdSecretKey }}
            - name: OIDC_GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.oidc.github.existingSecret }}
                  key: {{ .Values.oidc.github.clientIdSecretKey }}
            {{- else }}
            - name: OIDC_GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: oidcGithubClientId
                  optional: true
            {{- end }}
            - name: OIDC_GITHUB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.oidc.github.existingSecret }}
                  key: {{ .Values.oidc.github.secretKey }}
            {{- else }}
            - name: OIDC_GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: oidcGithubClientId
                  optional: true
            - name: OIDC_GITHUB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: oidcGithubClientSecret
                  optional: true
            {{- end }}
      {{- if .Values.deployment.extraInitContainers  }}
        {{- tpl  .Values.deployment.extraInitContainers . | nindent 8 }}
      {{- end }}
      {{- if and ( .Values.kratos.automigration.enabled ) ( eq .Values.kratos.automigration.type "initContainer" ) }}
        - name: {{ .Chart.Name }}-automigrate
          image: {{ include "judge.image.repository" . }}:{{ include "judge.imageTag" (dict "service" "kratos" "context" .) }}
          imagePullPolicy: {{ include "judge.image.pullPolicy" . }}
          {{- if .Values.kratos.automigration.customCommand }}
          command: {{- toYaml .Values.kratos.automigration.customCommand | nindent 12 }}
          {{- else }}
          command: ["kratos"]
          {{- end }}
          {{- if .Values.kratos.automigration.customArgs }}
          args: {{- toYaml .Values.kratos.automigration.customArgs | nindent 12 }}
          {{- else }}
          args: ["migrate", "sql", "-e", "--yes", "--config", "/etc/config/kratos/kratos.yaml"]
          {{- end }}
          volumeMounts:
            - name: {{ include "kratos.name" . }}-config-processed
              mountPath: /etc/config/kratos
              readOnly: true
          {{- with .Values.deployment.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
          env:
            - name: DSN
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: dsn
          {{- if $migrationExtraEnv }}
            {{- toYaml $migrationExtraEnv | nindent 12 }}
          {{- end }}
          {{- with .Values.kratos.automigration.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- end }}
      volumes:
        {{- if .Values.deployment.extraVolumes }}
        {{- toYaml .Values.deployment.extraVolumes | nindent 8 }}
        {{- end }}
        - name: {{ include "kratos.name" . }}-config-volume
          configMap:
            name: {{ include "kratos.fullname" . }}-config
        - name: {{ include "kratos.name" . }}-config-processed
          emptyDir: {}
        {{- $root := . -}}
        {{- range $method, $methodEntry := .Values.kratos.emailTemplates }}
        {{- range $result, $resultEntry := $methodEntry }}
        - name: {{ include "kratos.name" $root }}-template-{{ $method | kebabcase }}-{{ $result }}-volume
          configMap:
            name: {{ include "kratos.fullname" $root }}-template-{{ $method | kebabcase }}-{{ $result }}
        {{- end }}
        {{- end }}
      automountServiceAccountToken: {{ .Values.deployment.automountServiceAccountToken }}
      serviceAccountName: {{ include "kratos.serviceAccountName" . }}
      terminationGracePeriodSeconds: {{ .Values.deployment.terminationGracePeriodSeconds }}
      containers:
        - name: {{ .Chart.Name }}
          image: {{ include "judge.image.repository" . }}:{{ include "judge.imageTag" (dict "service" "kratos" "context" .) }}
          imagePullPolicy: {{ include "judge.image.pullPolicy" . }}
          command:
            - kratos
          args:
            - serve
            - all
            - --sqa-opt-out
            {{- if .Values.kratos.development }}
            - --dev
            {{- end }}
            - --config
            - /etc/config/kratos/kratos.yaml
            {{- if .Values.deployment.extraArgs }}
              {{- toYaml .Values.deployment.extraArgs | nindent 12 }}
            {{- end }}
          volumeMounts:
            {{- if .Values.deployment.extraVolumeMounts }}
              {{- toYaml .Values.deployment.extraVolumeMounts | nindent 12 }}
            {{- end }}
            - name: {{ include "kratos.name" . }}-config-processed
              mountPath: /etc/config/kratos
              readOnly: true
            {{- $root := . -}}
            {{- range $method, $methodEntry := .Values.kratos.emailTemplates }}
            {{- range $result, $resultEntry := $methodEntry }}
            - name: {{ include "kratos.name" $root }}-template-{{ $method | kebabcase }}-{{ $result }}-volume
              mountPath: /conf/courier-templates/{{ $method | snakecase }}/{{ $result }}
              readOnly: true
            {{- end }}
            {{- end }}
          env:
            - name: DSN
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: dsn
            - name: SECRETS_DEFAULT
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: secretsDefault
                  optional: true
            - name: SECRETS_COOKIE
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: secretsCookie
                  optional: true
            - name: SECRETS_CIPHER
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: secretsCipher
                  optional: true
            {{- if .Values.oidc.github.existingSecret }}
            {{- if .Values.oidc.github.clientIdSecretKey }}
            - name: OIDC_GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.oidc.github.existingSecret }}
                  key: {{ .Values.oidc.github.clientIdSecretKey }}
            {{- else }}
            - name: OIDC_GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: oidcGithubClientId
                  optional: true
            {{- end }}
            - name: OIDC_GITHUB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.oidc.github.existingSecret }}
                  key: {{ .Values.oidc.github.secretKey }}
            {{- else }}
            - name: OIDC_GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: oidcGithubClientId
                  optional: true
            - name: OIDC_GITHUB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: oidcGithubClientSecret
                  optional: true
            {{- end }}
            {{- if and .Values.kratos.config.courier.smtp.connection_uri (ne .Values.kratos.config.courier.smtp.connection_uri "") }}
            - name: COURIER_SMTP_CONNECTION_URI
              valueFrom:
                secretKeyRef:
                  name: {{ include "kratos.secretname" . }}
                  key: smtpConnectionURI
                  optional: true
            {{- end }}
            {{- if .Values.kratos.dev_disable_api_flow_enforcement }}
            - name: DEV_DISABLE_API_FLOW_ENFORCEMENT
              value: "true"
            {{- end }}
            {{- if .Values.deployment.extraEnv }}
              {{- toYaml .Values.deployment.extraEnv | nindent 12 }}
            {{- end }}
        {{- if .Values.deployment.environmentSecretsName }}
          envFrom:
          - secretRef:
              name: {{ .Values.deployment.environmentSecretsName }}
        {{- end}}
          ports:
            - name: http-admin
              containerPort: {{ .Values.kratos.config.serve.admin.port }}
              protocol: TCP
            - name: http-public
              containerPort: {{ .Values.kratos.config.serve.public.port }}
              protocol: TCP
          lifecycle:
            {{- toYaml .Values.deployment.lifecycle | nindent 12 }}
          livenessProbe:
          {{- if .Values.deployment.customLivenessProbe }}
            {{- toYaml .Values.deployment.customLivenessProbe | nindent 12 }}
          {{- else }}
            httpGet:
              path: /admin/health/alive
              port: {{ .Values.kratos.config.serve.admin.port }}
              httpHeaders:
                - name: Host
                  value: '127.0.0.1'
            {{- toYaml .Values.deployment.livenessProbe | nindent 12 }}
          {{- end }}
          readinessProbe:
          {{- if .Values.deployment.customReadinessProbe }}
            {{- toYaml .Values.deployment.customReadinessProbe | nindent 12 }}
          {{- else }}
            httpGet:
              path: /admin/health/ready
              port: {{ .Values.kratos.config.serve.admin.port }}
              httpHeaders:
                - name: Host
                  value: '127.0.0.1'
            {{- toYaml .Values.deployment.readinessProbe | nindent 12 }}
          {{- end }}
          startupProbe:
            {{- if .Values.deployment.customStartupProbe }}
              {{- toYaml .Values.deployment.customStartupProbe | nindent 12 }}
            {{- else }}
            httpGet:
              path: /admin/health/ready
              port: {{ .Values.kratos.config.serve.admin.port }}
              httpHeaders:
                - name: Host
                  value: '127.0.0.1'
            {{- toYaml .Values.deployment.startupProbe | nindent 12 }}
            {{- end }}
          resources:
            {{- toYaml .Values.deployment.resources | nindent 12 }}
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
        {{- if .Values.deployment.extraContainers }}
          {{- tpl .Values.deployment.extraContainers . | nindent 8 }}
        {{- end }}
      {{- with .Values.priorityClassName }}
      priorityClassName: {{ . }}
      {{- end }}
      {{- with .Values.deployment.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- with .Values.deployment.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.deployment.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.deployment.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.deployment.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.deployment.dnsConfig }}
      dnsConfig:
        {{- toYaml . | nindent 8 }}
    {{- end }}
