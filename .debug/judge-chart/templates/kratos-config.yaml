---
apiVersion: v1
kind: ConfigMap
metadata:
  name: RELEASE-NAME-judge-kratos-config
  namespace: NAMESPACE
  labels:
    app.kubernetes.io/name: judge-kratos
    app.kubernetes.io/instance: RELEASE-NAME
    app.kubernetes.io/managed-by: Helm
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
data:
  # Complete kratos config generated by judge.kratos.config.complete helper
  "kratos.yaml": |
    cookies:
      domain: judge.testifysec-demo.xyz
      path: /
      same_site: Lax
    courier:
      smtp:
        connection_uri: smtps://test:test@mailslurper:1025/?skip_ssl_verify=true
    identity:
      default_schema_id: default
      schemas:
      - id: default
        url: base64://eyIkaWQiOiJodHRwczovL3NjaGVtYXMub3J5LnNoL3ByZXNldHMva3JhdG9zL3F1aWNrc3RhcnQvZW1haWwtcGFzc3dvcmQvaWRlbnRpdHkuc2NoZW1hLmpzb24iLCIkc2NoZW1hIjoiaHR0cDovL2pzb24tc2NoZW1hLm9yZy9kcmFmdC0wNy9zY2hlbWEjIiwidGl0bGUiOiJQZXJzb24iLCJ0eXBlIjoib2JqZWN0IiwicHJvcGVydGllcyI6eyJ0cmFpdHMiOnsidHlwZSI6Im9iamVjdCIsInByb3BlcnRpZXMiOnsiZW1haWwiOnsidHlwZSI6InN0cmluZyIsImZvcm1hdCI6ImVtYWlsIiwidGl0bGUiOiJFLU1haWwiLCJtaW5MZW5ndGgiOjMsIm9yeS5zaC9rcmF0b3MiOnsiY3JlZGVudGlhbHMiOnsid2ViYXV0aG4iOnsiaWRlbnRpZmllciI6dHJ1ZX19LCJ2ZXJpZmljYXRpb24iOnsidmlhIjoiZW1haWwifX19LCJuYW1lIjp7InR5cGUiOiJzdHJpbmciLCJ0aXRsZSI6IkZ1bGwgTmFtZSIsIm1pbkxlbmd0aCI6MX19LCJyZXF1aXJlZCI6WyJlbWFpbCIsIm5hbWUiXSwiYWRkaXRpb25hbFByb3BlcnRpZXMiOmZhbHNlfSwibWV0YWRhdGFfcHVibGljIjp7ImFzc2lnbmVkX3RlbmFudHMiOnsidHlwZSI6ImFycmF5IiwiaXRlbXMiOlt7InR5cGUiOiJzdHJpbmcifV19fX19Cg==
      - id: other
        url: base64://eyIkaWQiOiJvcnk6Ly9pZGVudGl0eS1vdGhlci1zY2hlbWEiLCIkc2NoZW1hIjoiaHR0cDovL2pzb24tc2NoZW1hLm9yZy9kcmFmdC0wNy9zY2hlbWEjIiwidGl0bGUiOiJJZGVudGl0eU90aGVyU2NoZW1hIiwidHlwZSI6Im9iamVjdCIsInByb3BlcnRpZXMiOnsidHJhaXRzIjp7InR5cGUiOiJvYmplY3QiLCJwcm9wZXJ0aWVzIjp7Im90aGVyIjp7InR5cGUiOiJzdHJpbmcifSwiZW1haWwiOnsidHlwZSI6InN0cmluZyIsInRpdGxlIjoiZW1haWwiLCJvcnkuc2gva3JhdG9zIjp7ImNyZWRlbnRpYWxzIjp7InBhc3N3b3JkIjp7ImlkZW50aWZpZXIiOnRydWV9fX19LCJuYW1lIjp7InR5cGUiOiJzdHJpbmciLCJ0aXRsZSI6IkZ1bGwgTmFtZSIsIm1pbkxlbmd0aCI6MX19LCJyZXF1aXJlZCI6WyJvdGhlciIsImVtYWlsIiwibmFtZSJdLCJhZGRpdGlvbmFsUHJvcGVydGllcyI6dHJ1ZX19fQo=
    log:
      format: json
      leak_sensitive_values: false
      level: info
    selfservice:
      allowed_return_urls:
      - https://login.testifysec-demo.xyz
      - https://login.testifysec-demo.xyz/post-auth
      - https://kratos.testifysec-demo.xyz
      - https://judge.testifysec-demo.xyz
      default_browser_return_url: https://judge.testifysec-demo.xyz
      flows:
        error:
          ui_url: https://login.testifysec-demo.xyz/error
        login:
          after:
            default_browser_return_url: https://judge.testifysec-demo.xyz
          lifespan: 10m
          ui_url: https://login.testifysec-demo.xyz/login
        logout:
          after:
            default_browser_return_url: https://login.testifysec-demo.xyz/login
        recovery:
          enabled: true
          ui_url: https://login.testifysec-demo.xyz/recovery
        registration:
          after:
            oidc:
              hooks:
              - hook: session
              - config:
                  body: base64://ZnVuY3Rpb24oY3R4KSB7CiAgICAgIGlkZW50aXR5SWQ6IGN0eC5pZGVudGl0eS5pZCwKICAgICAgdHJhaXRzOiBjdHguaWRlbnRpdHkudHJhaXRzCn0=
                  method: POST
                  url: http://RELEASE-NAME-judge-api.NAMESPACE.svc.cluster.local:8080/webhook/defaulttenant
                hook: web_hook
          lifespan: 10m
          ui_url: https://login.testifysec-demo.xyz/registration
        settings:
          privileged_session_max_age: 15m
          required_aal: highest_available
          ui_url: https://login.testifysec-demo.xyz/settings
        verification:
          after:
            default_browser_return_url: https://login.testifysec-demo.xyz/
          enabled: true
          ui_url: https://login.testifysec-demo.xyz/verification
      methods:
        oidc:
          enabled: true
          config:
            providers: []
        password:
          enabled: false
    serve:
      admin:
        base_url: http://RELEASE-NAME-judge-kratos-admin.NAMESPACE.svc.cluster.local
        port: 4433
      public:
        base_url: https://kratos.testifysec-demo.xyz
        cors:
          allowed_headers:
          - Authorization
          - Cookie
          - Content-Type
          allowed_methods:
          - POST
          - GET
          - PUT
          - PATCH
          - DELETE
          allowed_origins:
          - https://*.testifysec-demo.xyz
          - https://testifysec-demo.xyz
          enabled: true
          exposed_headers:
          - Content-Type
          - Set-Cookie
        port: 4434

  # GitHub OIDC mapper
  "github.jsonnet": |
    local claims = {
    email_verified: false
    } + std.extVar('claims');

    {
      identity: {
        traits: {
                  // Allowing unverified email addresses enables account
                  // enumeration attacks, especially if the value is used for
                  // e.g. verification or as a password login identifier.
                  //
                  // Therefore we only return the email if it (a) exists and (b) is marked verified
                  // by GitHub.
          [if "email" in claims && claims.email_verified then "email" else null]: claims.email,
          [if "name" in claims then "name" else null]: claims.name,
        },
        metadata_public: {
          assigned_tenants: []
        }
      },
    }

  # GitLab OIDC mapper
  "gitlab.jsonnet": |
    local claims = {
    email_verified: false
    } + std.extVar('claims');

    {
      identity: {
        traits: {
                  // Allowing unverified email addresses enables account
                  // enumeration attacks, especially if the value is used for
                  // e.g. verification or as a password login identifier.
                  //
                  // Therefore we only return the email if it (a) exists and (b) is marked verified
                  // by GitLab.
          [if "email" in claims && claims.email_verified then "email" else null]: claims.email,
          [if "name" in claims then "name" else null]: claims.name,
        },
        metadata_public: {
          assigned_tenants: []
        }
      },
    }

  # Metadata webhook for judge-api integration
  "metadata_webhook.jsonnet": |
    function(ctx) {
      identityId: ctx.identity.id,
      traits: ctx.identity.traits,
    }

  # Force pod restart with enhanced init container logging (v2)