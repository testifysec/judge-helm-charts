suite: Fulcio Createcerts Job Validation
templates:
  - createcerts-job.yaml
tests:
  - it: should create a Job with required pod template labels
    set:
      createcerts.enabled: true
    asserts:
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: RELEASE-NAME-fulcio-createcerts
      # Kubernetes 1.21+ requires spec.template.metadata.labels for Jobs
      - isNotEmpty:
          path: spec.template.metadata.labels
      - matchRegex:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          pattern: fulcio
      - matchRegex:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          pattern: RELEASE-NAME

  - it: should not have an explicit spec.selector (auto-generated by Kubernetes)
    set:
      createcerts.enabled: true
    asserts:
      - isKind:
          of: Job
      # spec.selector should NOT be in the template - Kubernetes auto-generates it
      - isNull:
          path: spec.selector

  - it: should disable Istio sidecar injection
    set:
      createcerts.enabled: true
    asserts:
      - equal:
          path: spec.template.metadata.annotations["sidecar.istio.io/inject"]
          value: "false"

  - it: should not create Job when disabled
    set:
      createcerts.enabled: false
    asserts:
      - hasDocuments:
          count: 0
