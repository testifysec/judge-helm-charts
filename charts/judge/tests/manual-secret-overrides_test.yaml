suite: Manual Secret Overrides - Judge API
templates:
  - ../charts/judge-api/templates/deployment.yaml

tests:
  # ============================================================================
  # JUDGE-API SECRET OVERRIDE TESTS
  # ============================================================================

  - it: should use default judge-api secret name when no manual override
    template: ../charts/judge-api/templates/deployment.yaml
    set:
      global.secrets.provider: manual
      judge-api.vault.enabled: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="JUDGE_API_SQL_STORE_CONNECTION_STRING")].valueFrom.secretKeyRef.name
          value: RELEASE-NAME-judge-api-database

  - it: should use custom judge-api secret name when manual override provided
    template: ../charts/judge-api/templates/deployment.yaml
    values:
      - ./test-values.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="JUDGE_API_SQL_STORE_CONNECTION_STRING")].valueFrom.secretKeyRef.name
          value: my-custom-db-secret

  - it: should use default judge-api secret key when no manual override
    template: ../charts/judge-api/templates/deployment.yaml
    set:
      global.secrets.provider: manual
      judge-api.vault.enabled: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="JUDGE_API_SQL_STORE_CONNECTION_STRING")].valueFrom.secretKeyRef.key
          value: connectionString

  - it: should use custom judge-api secret key when manual override provided
    template: ../charts/judge-api/templates/deployment.yaml
    values:
      - ./test-values.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="JUDGE_API_SQL_STORE_CONNECTION_STRING")].valueFrom.secretKeyRef.key
          value: db-url

