suite: Kratos Cookie Domain Configuration
templates:
  - kratos-config.yaml
tests:
  - it: should use base domain for cookies to enable cross-subdomain access (production)
    set:
      global.domain: testifysec.dev
      kratos.enabled: true
      istio.enabled: true
      istio.domain: testifysec.dev
      istio.hosts.web: "judge"
      istio.hosts.login: "login"
      istio.hosts.kratos: "kratos"
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: testifysec\\.dev"
      # Verify cookies work across subdomains (judge, login, kratos)
      - notMatchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: judge\\.testifysec\\.dev"

  - it: should use base domain for cookies to enable cross-subdomain access (staging)
    set:
      global.domain: testifysec.dev
      kratos.enabled: true
      istio.enabled: true
      istio.domain: testifysec.dev
      istio.hosts.web: "staging-judge"
      istio.hosts.login: "staging-login"
      istio.hosts.kratos: "staging-kratos"
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: testifysec\\.dev"
      # Verify cookies work across subdomains (staging-judge, staging-login, staging-kratos)
      - notMatchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: staging-judge\\.testifysec\\.dev"

  - it: should use base domain for cookies to enable cross-subdomain access (dev)
    set:
      global.domain: testifysec.dev
      kratos.enabled: true
      istio.enabled: true
      istio.domain: testifysec.dev
      istio.hosts.web: "dev-judge"
      istio.hosts.login: "dev-login"
      istio.hosts.kratos: "dev-kratos"
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: testifysec\\.dev"
      # Verify cookies work across subdomains (dev-judge, dev-login, dev-kratos)
      - notMatchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: dev-judge\\.testifysec\\.dev"

  - it: should handle different base domains correctly
    set:
      global.domain: example.com
      kratos.enabled: true
      istio.enabled: true
      istio.domain: example.com
      istio.hosts.web: "app"
      istio.hosts.login: "login"
      istio.hosts.kratos: "auth"
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: example\\.com"
      - notMatchRegex:
          path: data["kratos.yaml"]
          pattern: "domain: app\\.example\\.com"
